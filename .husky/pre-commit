#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Exit immediately if a command exits with a non-zero status.
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "${BLUE}ğŸš€ Running pre-commit checks...${NC}"

# 1. Lint & Format (ESLint + Prettier)
echo "ğŸ¨ Running lint-staged..."
npx lint-staged --concurrent false
echo "${GREEN}âœ“ Lint-staged passed${NC}"
echo ""

# 2. Typescript Type Check
echo "ğŸ§© Checking TypeScript types..."
npx tsc --noEmit
echo "${GREEN}âœ“ TypeScript types are valid${NC}"
echo ""

# 3. Test (Run only if there are staged changes to testable files)
echo "ğŸ§ª Checking for files to test..."
STAGED_TEST_FILES=$(git diff --cached --name-only --diff-filter=ACM -- "*.js" "*.jsx" "*.ts" "*.tsx")

if [ -n "$STAGED_TEST_FILES" ]; then
  echo "ğŸ”¬ Running related tests..."
  # --bail: ì²« ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
  # --findRelatedTests: ë³€ê²½ëœ íŒŒì¼ê³¼ ê´€ë ¨ëœ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
  # --passWithNoTests: í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ì–´ë„ í†µê³¼
  npx jest --bail --findRelatedTests --passWithNoTests $STAGED_TEST_FILES
  echo "${GREEN}âœ“ All related tests passed${NC}"
  echo ""
else
  echo "ğŸ¤· No testable files staged. Skipping tests.${NC}"
  echo ""
fi

echo "${GREEN}âœ… All pre-commit checks passed! Commit authorized.${NC}"